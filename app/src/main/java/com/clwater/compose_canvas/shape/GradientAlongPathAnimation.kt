package com.clwater.compose_canvas.shape

import androidx.compose.animation.core.Animatable
import androidx.compose.animation.core.infiniteRepeatable
import androidx.compose.animation.core.tween
import androidx.compose.foundation.Canvas
import androidx.compose.foundation.layout.Box
import androidx.compose.foundation.layout.aspectRatio
import androidx.compose.foundation.layout.fillMaxSize
import androidx.compose.runtime.Composable
import androidx.compose.runtime.LaunchedEffect
import androidx.compose.runtime.remember
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.geometry.Offset
import androidx.compose.ui.graphics.Brush
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.PathMeasure
import androidx.compose.ui.graphics.StrokeCap
import androidx.compose.ui.graphics.asAndroidPath
import androidx.compose.ui.graphics.lerp
import androidx.compose.ui.graphics.vector.PathParser
import androidx.compose.ui.tooling.preview.Preview
import androidx.core.graphics.flatten
import kotlin.math.floor


@Composable
@Preview
fun GradientAlongPathAnimation() {
    val path = remember {
        HelloPath.test.toPath()
    }
    val bounds = path.getBounds()

    val totalLength = remember {
        val pathMeasure = PathMeasure()
        pathMeasure.setPath(path, false)
        pathMeasure.length
    }
    val lines = remember {
        path.asAndroidPath().flatten(0.5f)
    }
    val progress = remember {
        Animatable(0f)
    }
    LaunchedEffect(Unit) {
        progress.animateTo(
            1f,
            animationSpec = infiniteRepeatable(tween(10000))
        )
    }
    Box(modifier = Modifier.fillMaxSize()) {
        Canvas(modifier = Modifier
            .align(Alignment.Center)
            .fillMaxSize()
            .aspectRatio(bounds.width / bounds.height)
            ,
            onDraw = {
                val currentLength = totalLength * progress.value
                lines.forEach { line ->
                    if (line.startFraction * totalLength < currentLength) {
                        val startColor = interpolateColors(line.startFraction, colors)
                        val endColor = interpolateColors(line.endFraction, colors)
                        drawLine(
                            brush = Brush.linearGradient(listOf(startColor, endColor)),
                            start = Offset(line.start.x, line.start.y),
                            end = Offset(line.end.x, line.end.y),
                            strokeWidth = 10f,
                            cap = StrokeCap.Round
                        )
                    }
                }
            })
    }
}

private val colors = listOf(
    Color(0xFF3FCEBC),
    Color(0xFF3CBCEB),
    Color(0xFF5F96E7),
    Color(0xFF816FE3),
    Color(0xFF9F5EE2),
    Color(0xFFBD4CE0),
    Color(0xFFDE589F),
    Color(0xFFFF645E),
    Color(0xFFFDA859),
    Color(0xFFFAEC54),
    Color(0xFF9EE671),
    Color(0xFF67E282),
    Color(0xFF3FCEBC)
)

private object HelloPath {
    val test = PathParser().parsePathString("" +
            "M470.74687,-40.2642v33.77539h3.28881v-69.53758h-3.28881v33.77539h-37.82132v-33.77539h-3.28881v69.53758h3.28881v-33.77539zM489.2838,-42.74768v-31.19257h36.62539v-2.08613h-39.9142v69.53758h39.9142v-2.08613h-36.62539v-32.18596h30.79522v-1.98679zM575.9888,-6.4888v-2.08613h-35.13047v-67.45145h-3.28881v69.53758zM625.76943,-6.4888v-2.08613h-35.13047v-67.45145h-3.28881v69.53758zM636.98128,-23.57518c0,9.73526 6.27864,17.58307 22.12472,17.58307c16.14507,0 22.42371,-7.84781 22.42371,-17.58307v-35.36482c0,-9.73526 -6.27864,-17.58307 -22.42371,-17.58307c-15.84609,0 -22.12472,7.84781 -22.12472,17.58307zM640.27009,-59.03934c0,-8.54319 4.93322,-15.49695 18.83591,-15.49695c14.05219,0 19.1349,6.95376 19.1349,15.49695v35.5635c0,8.54319 -5.08271,15.49695 -19.1349,15.49695c-13.9027,0 -18.83591,-6.95376 -18.83591,-15.49695zM192.8424,112.71847v-67.45145h22.87218v-2.08613h-49.03317v2.08613h22.87218v67.45145zM266.39216,78.94308v33.77539h3.28881v-69.53758h-3.28881v33.77539h-37.82132v-33.77539h-3.28881v69.53758h3.28881v-33.77539zM281.64028,43.1809v69.53758h3.28881v-69.53758zM318.56465,42.6842c-15.09863,0.09934 -21.52676,7.0531 -21.52676,17.18572c0,19.1725 40.06369,18.57647 40.06369,36.15954c0,8.44385 -4.93322,15.09959 -18.68642,15.09959c-13.75321,0 -18.68642,-6.65574 -18.68642,-15.09959v-3.47688h-3.13932v3.37754c0,9.63592 5.97966,17.28505 21.82574,17.28505c15.99558,0 21.97523,-7.64913 21.97523,-17.28505c0,-18.87449 -40.06369,-18.37779 -40.06369,-36.15954c0,-8.24517 4.63423,-15.09959 18.38744,-15.09959c13.60372,0 18.23795,6.95376 18.23795,15.19893v1.39075h3.28881v-1.29141c0,-9.53658 -5.83016,-17.28505 -21.67625,-17.28505zM375.22188,43.1809v69.53758h3.28881v-69.53758zM412.14625,42.6842c-15.09863,0.09934 -21.52676,7.0531 -21.52676,17.18572c0,19.1725 40.06369,18.57647 40.06369,36.15954c0,8.44385 -4.93322,15.09959 -18.68642,15.09959c-13.75321,0 -18.68642,-6.65574 -18.68642,-15.09959v-3.47688h-3.13932v3.37754c0,9.63592 5.97966,17.28505 21.82574,17.28505c15.99558,0 21.97523,-7.64913 21.97523,-17.28505c0,-18.87449 -40.06369,-18.37779 -40.06369,-36.15954c0,-8.24517 4.63423,-15.09959 18.38744,-15.09959c13.60372,0 18.23795,6.95376 18.23795,15.19893v1.39075h3.28881v-1.29141c0,-9.53658 -5.83016,-17.28505 -21.67625,-17.28505zM490.47973,42.6842c-15.84609,0 -21.82574,7.94715 -21.82574,17.58307v35.36482c0,9.63592 5.97966,17.58307 21.82574,17.58307c15.99558,0 21.97523,-7.94715 21.97523,-17.58307v-7.54979h-3.28881v7.64913c0,8.44385 -4.78372,15.39761 -18.53693,15.39761c-13.9027,0 -18.68642,-6.95376 -18.68642,-15.39761v-35.5635c0,-8.44385 4.78372,-15.49695 18.68642,-15.49695c13.75321,0 18.53693,7.0531 18.53693,15.49695v5.46367h3.28881v-5.36433c0,-9.63592 -5.97966,-17.58307 -21.97523,-17.58307zM562.53458,112.71847v-2.08613h-35.13047v-67.45145h-3.28881v69.53758zM612.4647,48.34655l16.89253,64.37193h4.33525l18.53693,-69.53758h-2.98983l-17.63998,66.16004l-17.04202,-65.76268h-4.03627l-18.08846,66.16004l-18.23795,-66.55739h-3.28881l18.83591,69.53758h4.78372zM707.39172,96.32747l6.12915,16.391h3.28881l-25.86201,-69.63692h-4.63423l-25.26404,69.63692h2.98983l6.12915,-16.391zM688.55581,45.66438l18.23795,48.6763h-36.02742zM745.51202,112.71847v-67.45145h22.87218v-2.08613h-48.88368v2.08613h22.72269v67.45145zM780.79198,76.45959v-31.19257h36.62539v-2.08613h-39.9142v69.53758h39.9142v-2.08613h-36.62539v-32.18596h30.79522v-1.98679zM829.0777,43.1809v69.53758h3.28881v-32.08662h12.85626c13.60372,0 22.87218,2.68216 22.87218,12.91412v10.92733c0,2.98018 0.44847,6.0597 2.54135,8.24517h3.58779c-2.39186,-2.18547 -2.84034,-5.56301 -2.84034,-8.24517v-10.92733c0,-7.64913 -4.93322,-12.71544 -16.59354,-13.90752c11.51084,-1.39075 16.59354,-6.0597 16.59354,-14.60289v-6.25838c0,-9.53658 -5.97966,-15.59629 -21.52676,-15.59629zM832.36651,78.54572v-33.2787h17.341c13.45422,0 18.38744,5.26499 18.38744,13.70884v6.35772c0,10.72865 -8.37152,13.21214 -22.87218,13.21214zM885.88442,43.08156l0.14949,15.99364h2.69084l0.29898,-15.99364zM922.6593,42.6842c-15.09863,0.09934 -21.52676,7.0531 -21.52676,17.18572c0,19.1725 40.06369,18.57647 40.06369,36.15954c0,8.44385 -4.93322,15.09959 -18.68642,15.09959c-13.75321,0 -18.68642,-6.65574 -18.68642,-15.09959v-3.47688h-3.13932v3.37754c0,9.63592 5.97966,17.28505 21.82574,17.28505c15.99558,0 21.97523,-7.64913 21.97523,-17.28505c0,-18.87449 -40.06369,-18.37779 -40.06369,-36.15954c0,-8.24517 4.63423,-15.09959 18.38744,-15.09959c13.60372,0 18.23795,6.95376 18.23795,15.19893v1.39075h3.28881v-1.29141c0,-9.53658 -5.83016,-17.28505 -21.67625,-17.28505zM78.25726,161.89147c-15.09863,0.09934 -21.52676,7.0531 -21.52676,17.18572c0,19.1725 40.06369,18.57647 40.06369,36.15954c0,8.44385 -4.93322,15.09959 -18.68642,15.09959c-13.75321,0 -18.68642,-6.65574 -18.68642,-15.09959v-3.47688h-3.13932v3.37754c0,9.63592 5.97966,17.28505 21.82574,17.28505c15.99558,0 21.97523,-7.64913 21.97523,-17.28505c0,-18.87449 -40.06369,-18.37779 -40.06369,-36.15954c0,-8.24517 4.63423,-15.09959 18.38744,-15.09959c13.60372,0 18.23795,6.95376 18.23795,15.19893v1.39075h3.28881v-1.29141c0,-9.53658 -5.83016,-17.28505 -21.67625,-17.28505zM152.85346,198.15035v33.77539h3.28881v-69.53758h-3.28881v33.77539h-37.82132v-33.77539h-3.28881v69.53758h3.28881v-33.77539zM213.99543,215.53475l6.12915,16.391h3.28881l-25.86201,-69.63692h-4.63423l-25.26404,69.63692h2.98983l6.12915,-16.391zM195.15952,164.87166l18.23795,48.6763h-36.02742zM234.92423,162.38817v69.53758h3.28881v-29.5038h14.94914c16.59354,0 24.06811,-5.26499 24.06811,-16.29166v-6.95376c0,-9.73526 -5.53118,-16.78836 -21.67625,-16.78836zM238.21304,200.33582v-35.86152h17.341c14.05219,0 18.38744,6.0597 18.38744,14.60289v7.15244c0,9.8346 -6.12915,14.10619 -20.7793,14.10619zM291.88044,195.66687v-31.19257h36.62539v-2.08613h-39.9142v69.53758h39.9142v-2.08613h-36.62539v-32.18596h30.79522v-1.98679zM363.33732,162.38817v69.53758h3.28881v-29.5038h14.94914c16.59354,0 24.06811,-5.26499 24.06811,-16.29166v-6.95376c0,-9.73526 -5.53118,-16.78836 -21.67625,-16.78836zM366.62613,200.33582v-35.86152h17.341c14.05219,0 18.38744,6.0597 18.38744,14.60289v7.15244c0,9.8346 -6.12915,14.10619 -20.7793,14.10619zM461.10468,215.53475l6.12915,16.391h3.28881l-25.86201,-69.63692h-4.63423l-25.26404,69.63692h2.98983l6.12915,-16.391zM442.26876,164.87166l18.23795,48.6763h-36.02742zM499.22498,231.92575v-67.45145h22.87218v-2.08613h-48.88368v2.08613h22.72269v67.45145zM572.32626,198.15035v33.77539h3.28881v-69.53758h-3.28881v33.77539h-37.82132v-33.77539h-3.28881v69.53758h3.28881v-33.77539zM656.6394,215.53475l6.12915,16.391h3.28881l-25.86201,-69.63692h-4.63423l-25.26404,69.63692h2.98983l6.12915,-16.391zM637.80348,164.87166l18.23795,48.6763h-36.02742zM680.70751,165.56703l37.37284,66.35872h4.03627v-69.53758h-3.13932v65.0673l-36.77488,-65.0673h-4.63423v69.53758h3.13932zM734.07593,162.38817v69.53758h3.28881v-69.53758zM807.62569,165.66637v66.25938h3.28881v-69.53758h-5.08271l-25.71252,65.96136l-25.71252,-65.96136h-5.08271v69.53758h2.98983v-66.25938l25.86201,66.0607h3.73728zM868.76766,215.53475l6.12915,16.391h3.28881l-25.86201,-69.63692h-4.63423l-25.26404,69.63692h2.98983l6.12915,-16.391zM849.93175,164.87166l18.23795,48.6763h-36.02742zM906.88796,231.92575v-67.45145h22.87218v-2.08613h-48.88368v2.08613h22.72269v67.45145zM938.87911,162.38817v69.53758h3.28881v-69.53758zM953.97774,214.83937c0,9.73526 6.27864,17.58307 22.12472,17.58307c16.14507,0 22.42371,-7.84781 22.42371,-17.58307v-35.36482c0,-9.73526 -6.27864,-17.58307 -22.42371,-17.58307c-15.84609,0 -22.12472,7.84781 -22.12472,17.58307zM957.26655,179.37521c0,-8.54319 4.93322,-15.49695 18.83591,-15.49695c14.05219,0 19.1349,6.95376 19.1349,15.49695v35.5635c0,8.54319 -5.08271,15.49695 -19.1349,15.49695c-13.9027,0 -18.83591,-6.95376 -18.83591,-15.49695zM1013.47531,165.56703l37.37284,66.35872h4.03627v-69.53758h-3.13932v65.0673l-36.77488,-65.0673h-4.63423v69.53758h3.13932z"
    )
    val path = PathParser().parsePathString(
        "M13.63 248.31C13.63 248.31 51.84 206.67 84.21 169.31C140" +
                ".84 103.97 202.79 27.66 150.14 14.88C131.01 10.23 116.36 29.88 107.26 45.33C69.7 108.92 58.03 214.33 57.54 302.57C67.75 271.83 104.43 190.85 140.18 193.08C181.47 195.65 145.26 257.57 154.53 284.39C168.85 322.18 208.22 292.83 229.98 277.45C265.92 252.03 288.98 231.22 288.98 200.45C288.98 161.55 235.29 174.02 223.3 205.14C213.93 229.44 214.3 265.89 229.3 284.14C247.49 306.28 287.67 309.93 312.18 288.46C337 266.71 354.66 234.56 368.68 213.03C403.92 158.87 464.36 86.15 449.06 30.03C446.98 22.4 440.36 16.57 432.46 16.26C393.62 14.75 381.84 99.18 375.35 129.31C368.78 159.83 345.17 261.31 373.11 293.06C404.43 328.58 446.29 262.4 464.66 231.67C468.66 225.31 472.59 218.43 476.08 213.07C511.33 158.91 571.77 86.19 556.46 30.07C554.39 22.44 547.77 16.61 539.87 16.3C501.03 14.79 489.25 99.22 482.76 129.35C476.18 159.87 452.58 261.35 480.52 293.1C511.83 328.62 562.4 265.53 572.64 232.86C587.34 185.92 620.94 171.58 660.91 180.29C616 166.66 580.86 199.67 572.64 233.16C566.81 256.93 573.52 282.16 599.25 295.77C668.54 332.41 742.8 211.69 660.91 180.29C643.67 181.89 636.15 204.77 643.29 227.78C654.29 263.97 704.29 268.27 733.08 256"
    )
    val riggarooPath = PathParser().parsePathString(
        """	
        M320 448.5C308.333 483 288.5 563.4 302.5 609C320 666 417.981 379.805 438.5 448.5C461.5 525.5 424 552.5 471 552.5C508.6 552.5 539.333 478.167 550 443.5C536 504.667 500 642.112 550 632C594.5 623 636.5 600.5 648.5 552.5C654.5 506.5 691.5 468.5 751.5 463.5C699.051 488 658 497 648.5 580.5C639 664 740.701 626.877 756.5 592C783 533.5 778.5 502.5 783 463.5C773.5 567.5 756.5 740 709 817C676.667 869.413 629 862.5 620 834C611 805.5 648.5 726.5 737.5 669.5C778.403 643.304 836.5 592 873.5 580.5C891 491 922.5 479.5 983.5 463.5C935.5 484.5 888.5 516 881 580.5C873.5 645 935 648 969 606C996.2 572.4 1010 497 1013.5 463.5C1003.67 564.333 976.6 776.2 947 817C910 868 842.766 870.039 846 834C853 756 924.5 683.5 977 660.5C1029.5 637.5 1086.5 580 1108.5 567.5C1130.5 555 1111.5 463.5 1206.5 463.5C1206.5 469.5 1140.5 456 1122 567.5C1106.57 660.5 1194.5 632 1206.5 600C1220.19 563.506 1248.5 455.5 1248.5 455.5C1248.5 455.5 1232.5 583.5 1248.5 621C1264.5 658.5 1349.5 603.5 1354 567.5C1358.5 531.5 1370.5 455.5 1370.5 455.5C1370.5 455.5 1333.5 633 1360 628C1386.5 623 1432.5 416.5 1480 469.5C1527.5 522.5 1474.5 584 1525 552C1582.05 515.851 1581 438 1660 442.5C1626.5 457.5 1564.08 465.399 1588 578C1608.5 674.5 1713 627.126 1713 547C1713 482.5 1696.5 470.5 1679 442.5C1679 442.5 1776.31 558.119 1798 525C1821.58 489 1832.5 435.5 1905 448.5M1905 448.5C1877.5 447 1817.9 456.7 1809.5 529.5C1799 620.5 1828.5 644.5 1872 630.5C1915.5 616.5 1936.5 569.5 1938 535C1939.5 500.5 1926 455.5 1905 448.5Z	
    """.trimIndent()
    )
}

private fun interpolateColors(
    progress: Float,
    colorsInput: List<Color>,
): Color {
    if (progress == 1f) return colorsInput.last()

    val scaledProgress = progress * (colorsInput.size - 1)
    val oldColor = colorsInput[scaledProgress.toInt()]
    val newColor = colorsInput[(scaledProgress + 1f).toInt()]
    val newScaledAnimationValue = scaledProgress - floor(scaledProgress)
    return lerp(start = oldColor, stop = newColor, fraction = newScaledAnimationValue)
}